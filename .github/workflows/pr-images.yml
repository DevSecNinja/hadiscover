name: Build PR Images

on:
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/pr-images.yml'
      - '.github/workflows/build-and-push-image.yml'

permissions:
  contents: read
  packages: write
  pull-requests: write

env:
  REGISTRY: ghcr.io

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      version_tag: ${{ steps.get_version.outputs.version_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get PR version
        id: get_version
        run: |
          OUTPUT=$(.github/scripts/extract-version.sh "pull_request" "${{ github.event.pull_request.number }}" "")
          echo "$OUTPUT" >> $GITHUB_OUTPUT

  build-and-push-backend:
    needs: [determine-version]
    uses: ./.github/workflows/build-and-push-image.yml
    with:
      registry: 'ghcr.io'
      image_name: '${{ github.repository }}/backend'
      version: ${{ needs.determine-version.outputs.version }}
      context_path: './backend'
      update_version_script: 'update-backend-version.sh'
      is_prerelease: 'true'

  build-and-push-frontend:
    needs: [determine-version]
    uses: ./.github/workflows/build-and-push-image.yml
    with:
      registry: 'ghcr.io'
      image_name: '${{ github.repository }}/frontend'
      version: ${{ needs.determine-version.outputs.version }}
      context_path: './frontend'
      update_version_script: 'update-frontend-version.sh'
      is_prerelease: 'true'
      build_args: |
        NEXT_PUBLIC_API_URL=/api/v1

  comment-on-pr:
    needs: [determine-version, build-and-push-backend, build-and-push-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Comment PR with image tags
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.determine-version.outputs.version }}';
            const registry = 'ghcr.io';
            const repo = context.repo.owner.toLowerCase() + '/' + context.repo.repo.toLowerCase();

            const backendImage = `${registry}/${repo}/backend:${version}`;
            const frontendImage = `${registry}/${repo}/frontend:${version}`;

            const comment = `## üê≥ Docker Images Published

            The following Docker images have been built and published for this PR:

            ### Backend
            \`\`\`bash
            docker pull ${backendImage}
            \`\`\`

            ### Frontend
            \`\`\`bash
            docker pull ${frontendImage}
            \`\`\`

            ### Test the PR build
            \`\`\`bash
            # Test backend
            docker run -d -p 8000:8000 -e ENVIRONMENT=development ${backendImage}
            curl http://localhost:8000/api/v1/health

            # Test frontend
            docker run -d -p 8080:80 ${frontendImage}
            curl http://localhost:8080/hadiscover/
            \`\`\`

            ### Using docker-compose
            \`\`\`yaml
            services:
              backend:
                image: ${backendImage}
                ports:
                  - "8000:8000"
                environment:
                  - ENVIRONMENT=development

              frontend:
                image: ${frontendImage}
                ports:
                  - "8080:80"
            \`\`\`

            ---
            *Images are tagged with \`${version}\` and will be retained for testing purposes.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
