name: Scheduled Indexing

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

permissions:
  contents: read

jobs:
  trigger-indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger indexing on production API
        run: |
          echo "Triggering indexing on production API..."
          
          # Check if API_URL secret is set
          if [ -z "${{ secrets.PRODUCTION_API_URL }}" ]; then
            echo "⚠️ PRODUCTION_API_URL secret not set, skipping indexing"
            exit 0
          fi
          
          # Trigger the indexing endpoint
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "${{ secrets.PRODUCTION_API_URL }}/index" \
            -H "Content-Type: application/json")
          
          # Extract HTTP status code
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS:/d')
          
          echo "Response: $body"
          echo "HTTP Status: $http_status"
          
          # Check if successful (200 or 429 rate limit is acceptable for scheduled runs)
          if [ "$http_status" = "200" ]; then
            echo "✓ Indexing triggered successfully"
            exit 0
          elif [ "$http_status" = "429" ]; then
            echo "⚠️ Rate limit reached (this is expected if indexing was recently triggered)"
            exit 0
          else
            echo "✗ Failed to trigger indexing (status: $http_status)"
            exit 1
          fi
