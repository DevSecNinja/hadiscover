name: Build PR Images

on:
  workflow_dispatch:
  #pull_request:
  # branches:
  #   - main
  # paths:
  #   - 'backend/**'
  #   - 'frontend/**'
  #   - '.github/workflows/pr-images.yml'
  #   - '.github/workflows/build-and-push-image.yml'

permissions:
  contents: read

env:
  REGISTRY: ghcr.io

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      version_tag: ${{ steps.get_version.outputs.version_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Get PR version
        id: get_version
        run: |
          OUTPUT="$(.github/scripts/extract-version.sh "pull_request" "${{ github.event.pull_request.number }}" "")"
          echo "$OUTPUT" >> $GITHUB_OUTPUT

  build-and-push-backend:
    permissions:
      packages: write
    needs: [determine-version]
    uses: ./.github/workflows/build-and-push-image.yml
    with:
      registry: "ghcr.io"
      image_name: "${{ github.repository }}/backend"
      version: ${{ needs.determine-version.outputs.version }}
      context_path: "./backend"
      update_version_script: "update-backend-version.sh"
      is_prerelease: true

  build-and-push-frontend:
    permissions:
      packages: write
    needs: [determine-version]
    uses: ./.github/workflows/build-and-push-image.yml
    with:
      registry: "ghcr.io"
      image_name: "${{ github.repository }}/frontend"
      version: ${{ needs.determine-version.outputs.version }}
      context_path: "./frontend"
      update_version_script: "update-frontend-version.sh"
      is_prerelease: true
      build_args: |
        NEXT_PUBLIC_API_URL=/api/v1

  comment-on-pr:
    permissions:
      pull-requests: write
    needs: [determine-version, build-and-push-backend, build-and-push-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Comment PR with image tags
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const script = require('./.github/scripts/comment-pr-images.js');
            await script({ github, context, version: '${{ needs.determine-version.outputs.version }}' });
